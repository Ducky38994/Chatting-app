<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Terminal</title>
<style>
body { margin:0; padding:0; font-family: monospace; background: #000; color: #fff; }
#messages { height: 70vh; overflow-y:auto; border: 1px solid #555; padding:10px; }
.msg { margin-bottom:10px; }
input, button { padding:8px; margin-top:5px; }
</style>
</head>
<body>

<h2>Chat Terminal</h2>

<div id="messages"></div>

<input type="text" id="msgInput" placeholder="Type a message...">
<button id="sendBtn">Send</button>

<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-messaging-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBK4pJpKtFPs19-J051xR6t77SBHYrg1k8",
    authDomain: "subpls-2c774.firebaseapp.com",
    databaseURL: "https://subpls-2c774-default-rtdb.firebaseio.com",
    projectId: "subpls-2c774",
    storageBucket: "subpls-2c774.firebasestorage.app",
    messagingSenderId: "834082653588",
    appId: "1:834082653588:web:a7b266363aa864249f3b81"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
const messaging = firebase.messaging();

let localMessages = JSON.parse(localStorage.getItem('localMessages') || '[]');

function renderMessages() {
    const container = document.getElementById('messages');
    container.innerHTML = '';
    localMessages.forEach(m => {
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerText = `${m.name}: ${m.text}`;
        container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
}

// Sign in anonymously
auth.signInAnonymously().catch(console.error);

let userName = 'User' + Math.floor(Math.random()*1000);

function pushMessageLocally(msg) {
    localMessages.push(msg);
    localStorage.setItem('localMessages', JSON.stringify(localMessages));
    renderMessages();
}

// Load from Firebase
db.ref('chat/messages').on('child_added', snap => {
    const msg = snap.val();
    pushMessageLocally(msg);
    // Show notification if permission granted
    if (Notification.permission === 'granted') {
        if (document.hidden) {
            new Notification(`${msg.name}`, { body: msg.text });
        }
    }
});

// Send message
document.getElementById('sendBtn').addEventListener('click', () => {
    const input = document.getElementById('msgInput');
    if (!input.value) return;
    const msg = { name: userName, text: input.value, timestamp: Date.now() };
    db.ref('chat/messages').push(msg);
    input.value = '';
});

// Ask notification permission
if ('Notification' in window && Notification.permission !== 'granted') {
    Notification.requestPermission();
}

// Render existing local messages
renderMessages();

// Service worker registration for background notifications
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js')
    .then(() => console.log('Service worker registered'));
}

// Get FCM token
messaging.getToken().then(token => {
    console.log("FCM token:", token);
}).catch(console.error);

messaging.onMessage(payload => {
    if (Notification.permission === 'granted') {
        new Notification(payload.notification.title, {
            body: payload.notification.body,
            icon: payload.notification.icon
        });
    }
});
</script>
</body>
</html>
